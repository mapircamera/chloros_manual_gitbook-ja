# インデックス/LUTサンドボックス

インデックス/LUTサンドボックスは、Chloros Image Viewer内に設けられたインタラクティブな作業領域です。ここでは、マルチスペクトルインデックスの計算やカラー可視化をリアルタイムで試行できます。この強力なツールにより、データセット全体を再処理することなく、様々なインデックスのテスト、値範囲の微調整、出版物に使える可視化の作成が可能です。

## インデックス/LUTサンドボックスとは？

### 目的

サンドボックスは以下の機能を提供します：

* **リアルタイム指数計算** - あらゆる植生指数を即座に適用
* **インタラクティブなLUT調整** - 色調のグラデーションと範囲を微調整
* **ワークフロー最適化** - バッチ処理前に最適な設定を決定

### サンドボックスとプロジェクト処理の比較

**インデックス/LUTサンドボックス（インタラクティブ）：**

* 1枚の画像を個別に処理
* 即時フィードバック
* 実験的・反復的
* ファイルへの永続的変更なし
* 探索とテストに最適

**プロジェクト処理（バッチ）：**

* データセット全体を一括処理
* 事前設定済みパラメータ
* 永続的な出力ファイル
* 処理に時間がかかる
* 設定が確定した状態での最適処理

{% hint style=&quot;success&quot; %}
**最適なワークフロー**: サンドボックスで実験し最適なインデックスとLUT設定を見つけ、プロジェクト処理時にデータセット全体に適用する。
{% endhint %}

***

## インデックス/LUTサンドボックスの操作

### 事前計算済みインデックスの理解

Chlorosでは、プロジェクト処理中にインデックスを適用できます。エクスポートに適用するインデックスとLUT設定を決定するには、画像ビューアのサンドボックスを使用するのが最も簡単です。

サンドボックスでは以下が可能です：

* **新しいインデックスとカラーグラデーション（LUT）を適用**してデータを可視化
* **可視化設定をインタラクティブに調整**
* **事前に計算済みのインデックス画像を表示**
* **全ズームレベルでピクセル値を検査**

### サンドボックスの起動

インデックス/LUTサンドボックスは、**画像ビューア** <img src="../.gitbook/assets/icon_image-viewer.JPG" alt="" data-size="line"> サイドバータブからアクセスします：

1. ファイルブラウザの画像グリッドで画像をクリックすると、**画像ビューア**タブが開きます <img src="../.gitbook/assets/icon_image-viewer.JPG" alt="" data-size="line"> タブで開きます
2. **イメージビューアー** <img src="../.gitbook/assets/icon_image-viewer.JPG" alt="" data-size="line"> タブをクリックすると、左側のポップアウトサイドバーが開きます（未開の場合）

### インデックス/LUTを適用する画像の選択

イメージビューアー <img src="../.gitbook/assets/icon_image-viewer.JPG" alt="" data-size="line"> サンドボックスでインデックスを操作するには：

1. メイン画像グリッドから**画像を開く**（クリック）
2. **画像ビューアー** <img src="../.gitbook/assets/icon_image-viewer.JPG" alt="" data-size="line"> タブが開きます
3. **レイヤードロップダウン**（ビューア右上）をクリック
4. ドロップダウンからレイヤーを選択：
   * RAW (反射率)

### 画像へのインデックス適用

画像が全画面表示され、**画像ビューア** <img src="../.gitbook/assets/icon_image-viewer.JPG" alt="" data-size="line"> タブのサイドバーが開いている状態：

1. サイドバー上部のインデックスボックスをチェック
2. 左ドロップダウンからカメラのフィルターを選択
3. 右ドロップダウンから目的のインデックス式を選択
4. フィルターチャンネルの色付き円を、下部のインデックス式内の対応位置にドラッグ
5. 式が有効になると画像が更新され、インデックス値が表示される
6. マウスカーソルを移動させると、カーソル位置の値を確認可能
7. ズームインして個々のピクセルとその関連値を確認

各インデックスには固有の値範囲と意味があります：

#### NDVI 例

```
Formula: (NIR - Red) / (NIR + Red)

For Survey3W RGN camera:
NIR = 850nm band
Red = 661nm band

Result range: -1.0 to +1.0
Typical vegetation: 0.4 to 0.9
Stressed vegetation: 0.2 to 0.4
Bare soil: 0.0 to 0.2
Water: -0.1 to 0.1
```

インデックス式の詳細なドキュメントは[マルチスペクトルインデックス式](../project-settings/multispectral-index-formulas.md)を参照してください。

***

## LUT（ルックアップテーブル）の操作

### LUTとは？

**ルックアップテーブル（LUT）**は、数値インデックス値を可視化用の色にマッピングします：

* **入力**: インデックスピクセル値（例: NDVI 0.65）
* **出力**: RGB 色（例：明るい緑）
* **目的**: パターンを視認・解釈しやすくする

**グレースケールLUTとカラーLUTの比較:**

* グレースケール: 科学的かつ中立的、生データを表示
* カラーLUT: 直感的でインパクトがあり、パターンや差異を強調

{% hint style=&quot;success&quot; %}
**可視化の力**: グレースケールインデックス画像にカラーLUTを適用すると、パターン・異常・注目領域を一目で識別することが劇的に容易になります。
{% endhint %}

### インデックス画像へのLUT適用手順

インデックス画像が表示されたら

1. <img src="../.gitbook/assets/image.png" alt="" data-size="line"> 「+LUT追加」ボタンをクリック
2. カラーグラデーションを選択
3. クリッピングの最小/最大終端点を調整
4. クリッピングモードを調整
5. **画像ビューアー** <img src="../.gitbook/assets/icon_image-viewer.JPG" alt="" data-size="line"> タブのサイドバーで「インデックス」ボックスをチェックしてLUTを適用

### カラーグラデーションの選択

**グラデーションの選択方法：**

1. LUTパネルで**カラーグラデーションバー**を探す
2. マウスを乗せて利用可能なプリセットを表示
3. 希望のグラデーションを選択
4. インデックスボックスチェック時、画像が**即時更新**され新色に変化

{% hint style=&quot;success&quot; %}
**ベストプラクティス**: NDVIのような植生指数では、Red-Yellow-Greenグラデーションが最も直感的です。これは自然界の色彩認識（緑＝健全、黄＝中程度、赤＝ストレス）に沿っているためです。
{% endhint %}

### 色クラスの調整

**クラス制御**は、グラデーションに表示される離散的な色の段階数を決定します：

**クラス数の選択肢:**

* **2-5クラス**: 非常に広いカテゴリー、明確なゾーン
* **6-10クラス**: バランスが取れており、分類に適している
* **11-20クラス**: 滑らかなグラデーション、連続的な見た目
* **20+クラス**: ほぼ連続的で、最大限の滑らかさ

**調整方法:**

1. LUTパネルで、**グラデーションバー下部のカラースウォッチ**を探します
2. +ボタンでクラス数を追加して調整します
3. カラースウォッチをダブルクリックするとクラス数が減ります
4. グラデーションは画像上で**リアルタイム**に更新されます

**視覚化への影響:**

* **少ないクラス数** (3-5): 明確な領域分け、分類の簡素化、カテゴリの識別容易性
* **中程度のクラス数** (6-10): バランスの取れたアプローチ、大半の用途に適す
* **多いクラス数** (15-20): 滑らかな遷移、詳細な差異表現、写真のような外観

**使用タイミング:**

* **少数のクラス (3-5)**: プレゼンテーションスライド、分類マップ、簡易レポート
* **中程度のクラス (6-10)**: 一般的な分析、バランスの取れた詳細、標準的なレポート
* **多数のクラス (15-20)**: 科学的な分析、詳細な検査、出版物レベルの出力

### 値範囲の微調整

**値範囲制御**は、グラデーション内のどのインデックス値がどの色にマッピングされるかを決定します：

**LUTパネル内の範囲制御：**

* **最小値**：カラースケールの下限
* **最大値**：カラースケールの上限
* **中間値**：最小値と最大値の間に自動配分 （クラス数に基づく）

#### 最小/最大値の調整

**値範囲を調整するには：**

1. LUTパネルで**最小値**と**最大値**の入力フィールドを探す
2. **最小値**フィールドをクリック
3. 希望の最小値を入力（例：`0.2`）
4. **Enter**キーを押すか、フィールド外をクリック
5. **最大値**フィールドでも同様に設定（例: `0.9`）
6. ビジュアライゼーションが**即時更新**されます

{% hint style=&quot;info&quot; %}
**自動スケーリング**: LUTを初めて適用すると、Chlorosが画像内の実際のデータ範囲に基づいて最小/最大値を自動設定します。その後、特定の関心値範囲に焦点を当てるため、この範囲を狭めることが可能です。
{% endhint %}

**範囲調整の例:**

* **全範囲**: `-1.0` ～ `1.0` (全値を表示)
* **植生に焦点を当てた範囲**: `0.2` ～ `0.9` (裸地と水域を除外)
* **健全な植生のみ**: `0.5` から `0.9` (活力のある植物のみを強調)
* **ストレス検出**: `0.2` から `0.5` （問題領域を強調）
* **カスタム範囲**：観測したピクセル値に基づいて調整

**範囲を調整する理由**

* 関心領域の**コントラスト向上**
* **無関係な値の除外**（例：水域、裸地）
* 複数画像や日付間の**可視化標準化**
* 狭い値範囲内の**微妙な差異の強調**

### 範囲外値のクリッピング

ピクセル値が定義した最小/最大範囲外の場合、**クリッピングモード**で表示方法を制御できます。

#### **利用可能なクリッピングモードオプション:**

#### 1. 最小値と最大値

* **最小値未満**のピクセル → グラデーションの**最初の色**（例：赤）で表示
* **最大値超過**のピクセル → グラデーションの**最後の色**（例：緑）で表示
* **使用例**：極端な値を強調し、限界値で飽和した色を用いて全データ範囲を表示
* **例**: NDVI値が0.2未満は全て赤、0.9超は全て緑で表示

#### 2. 透明背景

* **範囲外のピクセル**は**完全に透明化**
* **範囲内のピクセル**のみがグラデーション表示
* **使用例**: GISオーバーレイ、特定値範囲の分離、関心領域のみの強調
* **例**: NDVI 0.4-0.7の範囲のみ着色表示、他は透明

{% hint style=&quot;warning&quot; %}
**透明度の制限**: 透明ピクセルはビューア上で背景色として表示されます。処理中のエクスポート時、透明度はPNG形式では保持されますが、JPG形式では保持されません。
{% endhint %}

#### 3. インデックス背景

* **範囲外**のピクセルは**グレースケール**で表示（生のインデックス値を表示）
* **範囲内**のピクセルは**カラーグラデーション**で表示
* **使用例**: 微妙な強調表示、文脈を維持しつつ関心領域を強調
* **例**: ストレスを受けた植生をカラー強調表示（NDVI 0.3-0.5）し、健全な領域をグレーで表示

#### 4. オリジナル背景

* **範囲外**のピクセルは**元のマルチスペクトル画像**を表示
* **範囲内**のピクセルは**カラーグラデーション**を表示
* **使用例**: 最も直感的 - 自然な画像コンテキストと分析用カラーオーバーレイを組み合わせ
* **例**: 実際の圃場/作物の外観を確認しつつ、色分けされたストレス領域をオーバーレイ表示

### 適切なクリッピングモードの選択

| クリッピングモード              | 最適な用途                                   | 視覚化スタイル           |
| -------------------------- | ------------------------------------------ | ---------------------------- |
| **最小値と最大値**    | 全データ表示、科学分析     | 全ピクセル着色           |
| **透明背景**       | GISオーバーレイ、特定範囲の分離    | 範囲内着色、範囲外無地 |
| **インデックス背景**       | 控えめな強調、データ文脈維持  | 範囲内着色、範囲外グレー  |
| **オリジナル背景**    | レポート、プレゼン、直感的分析 | 範囲内着色、範囲外写真 |

### カスタムLUTカラーの作成

可視化を完全に制御するには、個々のカラーストップを編集して**カスタムカラーグラデーション**を作成できます。

**カスタムグラデーションの作成手順:**

1. LUTパネルで**グラデーションプレビューバー**を探す
2. グラデーション下部の**カラースウォッチ四角**を探す
3. **カラースストップをクリック**して選択する
4. **カラーピッカー**が開きます
5. 以下の方法で新色を選択:
   * **カラーホイール**: 視覚的な色選択
   * **RGB/HSVスライダー**: 精密な色制御
   * **16進コード入力**: 厳密な色指定 (例: 赤は `#FF0000`)
6. カラーピッカーの外側をクリックすると**新しい色が適用されます**
7. 画像上のグラデーションが**即時更新されます**

**カラーストップの追加・削除:**

* **ストップ追加**: +アイコンをクリックし、末尾に新しいスウォッチを追加
* **ストップ削除**: 色の四角をダブルクリックし、スウォッチを削除

**カスタマイズ戦略:**

* **グラデーション反転**: 色順を反転させて意味を逆転（例: 緑=低、赤=高）
* **ブランドカラー**: レポート用に組織のカラーパレットに合わせる
* **色覚障害対応**: オレンジ-青または紫-黄色の組み合わせを使用
* **印刷最適化**：カラー印刷とグレースケール印刷の両方で効果的な色を選択
* **多重しきい値**：特定の値のしきい値で分類するために異なる色を使用

{% hint style=&quot;info&quot; %}
**カスタムグラデーションの保存**：カスタムグラデーションは保存して再利用できます。 LUTパネルの保存アイコンをクリックすると、カスタムカラースキームを将来使用するために保存できます。
{% endhint %}

***

## インタラクティブワークフロー

### リアルタイム更新

サンドボックス内のすべてのLUT調整は、画像を**瞬時にインタラクティブに**更新します：

* **レイヤー切り替え** → 画像が即座に変更
* **グラデーション選択** → 色が瞬時に更新
* **値範囲調整** → コントラストがリアルタイムで変化
* **クラス変更** → グラデーションの滑らかさが即時更新
* **クリッピング変更** → 背景表示が瞬時に変化
* **色編集** → カスタムグラデーションが即時適用

**「適用」ボタン不要** - 全ての変更がライブかつインタラクティブ！

{% hint style=&quot;success&quot; %}
**ライブフィードバック**: 瞬時の視覚的フィードバックにより、分析ニーズに最適な可視化を見つけるまで様々な設定を迅速に試行できます。
{% endhint %}

### 反復的改善ワークフロー

**典型的なLUT最適化ワークフロー:**

1. **インデックス層を選択** (例: RAW (反射率))
2. **インデックスを適用** - カメラフィルターとインデックス式を選択し、色付き円をインデックス式内の適切な位置にドラッグ
3. **LUTグラデーションを適用** - Red-Yellow-Greenプリセットから開始
4. **ピクセル値を確認** - カーソルを移動させ、値の範囲を把握
5. **最小/最大値を調整** - 植生に焦点を絞るため範囲を狭める（例：0.2～0.9）
6. **クリッピング選択** - コンテキスト確認のため「オリジナル背景」を試す
7. **色調調整** - 特定強調が必要な場合、グラデーションをカスタマイズ
8. **設定確定** - 設定を記録し、エクスポート処理用にプロジェクト設定へコピー

### ピクセル値確認

効果的なLUT範囲設定には実際のピクセル値の理解が不可欠：

**値の確認方法：**

1. ピクセル値は、画像でインデックスボックス、またはインデックスとLUTの両方のボックスが**チェックされている**場合に表示されます。
2. **カーソルを移動**させて画像の異なる領域を確認
3. ホバー時に表示されるレジェンドで**ピクセル値を観察**
4. ズームインして個々のピクセルを拡大表示し、浮動小数点値を確認
5. 異なる特徴の値範囲を**記録**する：
   * **健全な植生**：例 NDVI 0.55-0.85
   * **ストレスを受けた植生**：例 NDVI 0.30-0.50
   * **裸地**：例 NDVI 0.05-0.25
   * **水域**（存在する場合）：例 NDVI -0.05～0.10

**ピクセル値を用いたLUT範囲の設定：**

ピクセル値を検証後、LUTの最小/最大値を適宜調整してください：

**例：**

* **観測結果**：土壌値 = 0.05-0.25、ストレス状態 = 0.25-0.50、健全状態 = 0.50-0.85
* **目標**：植物の健全状態のみ可視化（土壌を除く）
* **LUT設定**: 最小値 = `0.25`, 最大値 = `0.85`
* **クリッピング**: 「オリジナル背景」を選択し、土壌を自然な色で表示
* **結果**: 色調変化は植生のみに適用され、土壌は元の画像のまま表示

{% hint style=&quot;info&quot; %}
**ダイナミックレンジ**: 作物・季節・生育段階により値の範囲が異なる。LUT範囲設定前には、必ず対象データセットのピクセル値を確認すること。
{% endhint %}

***

## カスタムインデックス (Chloros+)

### カスタムインデックス式の作成

{% hint style=&quot;info&quot; %}
**作成場所**: カスタムインデックスは、処理前の**プロジェクト設定**およびイメージビューアーのサンドボックスサイドバーで設定可能です。
{% endhint %}

**カスタムインデックスの作成方法:**

1. **プロジェクト設定**（処理前）またはイメージビューアーのサンドボックスサイドバーを開く
2. **インデックス計算式ドロップダウン**に移動
3. **「カスタム」**オプションを探す（Chloros+ライセンスでのログイン必須）
4. バンド変数を使用して**式を定義**:
   * バンド名: `NIR`、`Red`、`Green`、`Blue`、`RedEdge` など
   * 演算子: `+`, `-`, `*`, `/`, `^` (指数)
   * 関数: `sqrt()`、`abs()` など（サポートされている場合）
   * 括弧: 演算順序指定用 `()`
5. **インデックスに名前を付ける**（例: &quot;MyIndex&quot; または &quot;CustomNDVI&quot;）
6. **設定を保存**

**カスタム式例:**

```
Modified NDVI with offset:
(NIR - Red) / (NIR + Red + 0.5)

Simple ratio:
NIR / Red

Complex multi-band:
(NIR - Red) / (NIR + Red - Blue)

Exponential index:
(NIR / Red) ^ 2
```

{% hint style=&quot;warning&quot; %}
**式検証**: 使用する式がカメラで利用可能なバンドを使用していることを確認してください。例えば、RedEdge は RedEdge フィルターを搭載したカメラでのみ利用可能です。
{% endhint %}

***

## 次のステップ

インデックス/LUTサンドボックスについて理解したところで：

* **処理への適用**: [プロジェクト設定](../project-settings/project-settings.md)で発見した設定を使用
* **バッチ処理**：最適化されたインデックスを全データセットに適用
* **詳細学習**：[マルチスペクトルインデックス式](../project-settings/multispectral-index-formulas.md) を読む

関連ドキュメント：

* [**画像レイヤー**](image-layers.md) - レイヤー管理と可視化
* [**画像の全画面表示**](opening-an-image-full-screen.md) - 画像ビューアーの基本操作
* [**画像処理（GUI）**](../processing-images-gui/adding-files-to-a-project.md) - 完全な処理ワークフロー
